# Releases

A **release** is a group of one or more code changes (commits) that have been merged into the `prod` branch, after passing code review and testing (in the **DEV** and **STAGE** environments). When referring to a particular release, it's implied that the code to include in that release has been finalized/locked, that the release has been created and that it is either ready to be deployed or has already been deployed to the **PROD** environment.
- PRs / branches being considered for inclusion in an upcoming release and work that has been merged into either the `dev` or `stage` branch  should all be considered "release candidate" code (or work for a particular sprint), but should not be referred to as a "release", to prevent confusion.
- If we say that a particular release has a bug, we generally mean that a bug was found _after_ that release was deployed to **PROD** (which would need to be addressed in a separate release; see **"Hotfix Releases"** section below for more details).

## Creating a Release
Each release is represented by a [git tag](https://www.atlassian.com/git/tutorials/inspecting-a-repository/git-tag#:~:text=Tags%20are%20ref's%20that%20point,no%20further%20history%20of%20commits.), which points to a particular commit in the `prod` branch's git history – this allows us to be very specific about what the release includes, instead of  just saying that we released the latest version of the `dev` branch. Checking out a particular release's git tag will always restore the codebase to the state it was in when that release was created, regardless of any new commits that have since been added to the `dev` branch (or other branches).
- The git tag for the release should only be created off the `prod` branch, once release candidate code has been merged into it (and must reference a commit within that branch).
- Each release is assigned a unique **Release Version**, which is used to name the git tag and indicates whether the release contains a major update, a minor update, or a hotfix. See the next section below for details on how to generate a new Release Version and use it in the release's git tag name.
- New releases are created by [adding a new release in the Github UI](https://docs.github.com/en/repositories/releasing-projects-on-github/managing-releases-in-a-repository?tool=webui); this  creates a git tag for the release and allows release notes to be attached to it. The project's most recent release and a list of all its releases can be found on the main github repo page, in the "Releases" section.
- When a new release is created, we must generate the release notes for it, containing a Changelog of all commits included in the release (with their associated owners). These release notes can be manually edited later, in order to include additional details, such as the sprint number(s) the release corresponds to or a list of security issues addressed.

## Assigning a Release Version

### Release Version Convention
Release versions for this project use the following semantic format, which is a simplified implementation of the [Semantic Versioning Specification](https://semver.org/):
```
MAJOR.MINOR.HOTFIX
```

A new Release Version is generated by taking the version number of the previous release and incrementing one of its version components by 1:
- `MAJOR` - incrementing the Major version for a release indicates a major change to the codebase which may not be backwards-compatible.
  - We've set the major version to "3" in our first numbered release. If we upgrade to Drupal 11 in the future, we'd increment the major version accordingly to "4"; however, this value could be incremented due to other significant architectural changes as well, such as updating the codebase to support a new major version of USWDS.
- `MINOR` - incrementing the Minor version for a release indicates minor changes to the codebase, including feature enhancements, new functionality, bug fixes or other backwards-compatible code. For most releases, this is the only portion of the Release Version that will be incremented.
  - The Minor version component should be reset to 0 each time the Major version is incremented.
- `HOTFIX` - incrementing the Hotfix version for a release indicates that the release contains one or more hotfixes. A hotfix addresses a critical bug that is identified after a release has already been deployed to the **STAGE** / **PROD** environments; these changes are typically committed and deployed to **PROD** on the same day as the original release, unless the bug is found later.
  - The Hotfix version component should be reset to 0 each time a new Release Version is created.

Note: the version components above should not include leading zeros. This project's Release Version does not use `-alpha` / `-beta` / `-rc` suffixes.

### Naming git tag for a release
The git tag name for a particular release consists of the Release Version described above, but prefixed with a "v" – these git tags are listed on the repo's Github page, under the "Releases" heading. For example, Release Version 4.0.0 has a corresponding git tag, with this name:
```
v4.0.0
```

## Release Schedule
- On this project, each two-week sprint will (ideally) only include a single release (and associated deployments).
- **All PRs proposed for inclusion in an upcoming release should be ready for code review and testing in the week prior, by Thursday (EOD).** This provides time on Friday and Monday for PRs to be tested and modified, if necessary.
- All approved PRs / release candidate code should be merged into the `dev` branch by Monday night (or whenever the day before the release deployment is), so that code in `dev` is ready for PRs to be created (for merging into `stage` and `prod` branches) and for the release to be deployed the following day.
  - Confirm that all code in the `dev` branch has been reviewed/tested and approved to include in the release.
- Release candidate code will typically be deployed to **STAGE** on a Tuesday, followed by a release deployment to **PROD** (later that day).
- In some cases, this schedule may be adjusted to account for holidays or team member PTO.
- **Deployments should NOT be performed on the following days**, unless absolutely necessary: on a Friday, on a day before a holiday, or on a day when multiple team members are on PTO (or will be on PTO the following day).

### Hotfix Release Schedule
- Hotfix Releases are unscheduled and often deployed to **PROD** as quickly as possible, once all associated bug fixes have been approved and tested in the **STAGE** environment.
- Hotfix Releases that fix major bugs or bugs that affect mission-critical functionality may be deployed the same day as the original deployment.
- Hotfix Releases that address less-critical bugs (or bugs that aren't discovered on the same day as the original deployment) may be deployed in the days following the original deployment, based on priority, the client's needs, and other factors. Scheduling a Hotfix Release should follow the same restrictions as detailed above for normal releases.


### Infrastructure Release Schedule
- Infrastructure Releases are unscheduled (like Hotfix Releases) and can be deployed to **PROD** once all associated bug fixes have been approved and tested in the **STAGE** environment.
- Scheduling an Infrastructure Release should follow the same restrictions as detailed above for normal releases.


### Release History
The release history for this project is documented on the repo's Github page (under the "Releases" heading).

## Releases require deployments

### Freezing code for the release
At the end of the active sprint a "release candidate" PR is create from approved and merged work from the `dev` branch with the target branch set to `stage`, that branch should be frozen (no new commits or PRs merged in) until it has been merged. If possible, this code freeze / merge should occur 2 or 3 days prior to the **PROD** deployment, so there is adequate time to properly test the release candidate code in the **STAGE** environment.

### Deploying to STAGE
**Merge strategy:** `Create a merge commit` This strategy maintains the history and commit ids in all environment branches.

Before a release can be created and deployed to the **PROD** environment, the approved "release candidate" PR must be merged from the `dev` branch into the `stage` branch, then  deployed to the **STAGE** environment and tested there.

If a bug is discovered on **STAGE** (after deploying "release candidate" code), it should be handled as a standard bug fix -- this is NOT considered a "hotfix" (see **"Hotfix Releases"** section below). Once the bug has been fixed and merged into the `dev` branch, it may be approved and merged into `stage` branch for inclusion in the "release candidate" and deployed to the **STAGE** environment for testing.
- If there isn't enough time to address a bug or deploy/test an approved bug fix on **STAGE**, then the original PR (where the bug was introduced) should be excluded from the upcoming release and included in a future one instead with the fix.

### Deploying to PROD
**Merge strategy:** `Create a merge commit` This strategy maintains the history and commit ids in all environment branches.

Once the "release candidate" in the `stage` branch has been successfully tested in the **STAGE** environment, a "release" PR is created to merge the `stage` branch into the `prod` branch. Once the "release" is approved and merged, a Git release and tag can be created capturing the release (using **"Release Version Convention"** found in this doc) and this git tag can be deployed to the **PROD** environment. After all work in the release has been tested in **PROD**, the release is considered complete.
- Any bugs found on **PROD**, following deployment (whether related to the release or not), must be addressed with a separate release (with its own Release Number) -- for critical bugs, a Hotfix release would be initiated; less-critical bugs could either be handled in a Hotfix release or in a future release. In either case, the original release should not be modified or recreated to include a bug fix / hotfix.
- Releases represent what has been deployed to the **PROD** environment, so there should be a corresponding release for every **PROD** deployment (even those involving a minor code fix).

## Hotfix Releases
After deploying a normal release to the **PROD** site, it's possible that a bug (or multiple bugs) will be discovered by the project team or the client; this may occur either on the day of the deployment or in the days that follow. If it's decided that the bug affects mission-critical functionality or otherwise requires an immediate fix, a hotfix should be created and deployed to **PROD** as soon as possible, as a **Hotfix Release**.
- A Hotfix Release is a special type of release that requires unscheduled deployments to the **STAGE** and **PROD** environments. For additional guidance on when to deploy a Hotfix Release, see the **"Hotfix Release Schedule"** section above.
- A Hotfix Release should only contain hotfixes for bugs found on the **PROD** site.
- If the bug found on **PROD** is not urgent enough to necessitate an immediate fix (and can be addressed in the next scheduled release cycle), the fix for this bug is NOT considered a hotfix.
- If a bug is found after deploying "release candidate" code to **STAGE**, this should be fixed and merged into the `dev` branch, then deployed to **STAGE** again; this type of bug fix is NOT considered a hotfix (and should not be handled as a Hotfix Release).

### To create a Hotfix Release:
- All hotfix code should be submitted as PR(s) against the `stage` branch. Because we want to avoid deploying non-hotfix code in the Hotfix Release, hotfix PRs should NOT be created against the `dev` branch.
- Once all hotfix PRs have been merged into `stage` branch, they should be deployed to the **STAGE** environment and tested there.
- After all hotfixes have been successfully tested on **STAGE**:
  - A single hotfix PR should be created to merge the `stage` branch into the `prod` branch.
  - An additional PR should be created to merge all hotfixes from `stage` branch back into the `dev` branch.

## Infrastructure Releases
Infrastructure-related code changes modify configuration or behavior outside of the application layer, generally involving specific environments or a deployment pipeline. If these changes need to be deployed before the next scheduled release cycle, they can be handled as an **Infrastructure Release**, which is very similar to a Hotfix Release.
- An Infrastructure Release is a special type of release that requires unscheduled deployments to the **STAGE** and **PROD** environments. For additional guidance on when to deploy a Hotfix Release, see the **"Infrastructure Release Schedule"** section above.
- As with a Hotfix Release, the release candidate code for an Infrastructure Release should be independent of any active development happening in the `dev` branch and should only include infrastrucure-related code changes.
- For additional guidance on when to deploy a Hotfix Release, see the **"Infrastructure Release Schedule"** section above.

### To create an Infrastructure Release:
(follow same steps as in the **"To create a Hotfix Release"** section above, creating PRs against the `stage` branch)
